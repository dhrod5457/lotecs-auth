# LOTECS Auth 연동 개요

새로운 MSA 서비스에서 LOTECS Auth 서비스와 연동하는 방법을 설명한다.

## 관련 문서

- [JWT 인증](02-JWT인증.md)
- [SSO 연동](03-SSO연동.md)
- [gRPC 클라이언트](04-gRPC클라이언트.md)
- [권한 관리](05-권한관리.md)
- [트러블슈팅](06-트러블슈팅.md)

---

## 개요

LOTECS Auth는 JWT 기반 토큰 인증을 제공하는 중앙 인증 서비스다. 다른 MSA 서비스는 다음 두 가지 방식으로 연동할 수 있다:

| 연동 방식 | 용도 | 통신 |
|-----------|------|------|
| JWT 토큰 검증 | HTTP 요청의 인증/인가 처리 | 토큰 자체 검증 (Auth 서비스 호출 불필요) |
| gRPC SDK | 사용자/역할/권한 조회, 토큰 발급 등 | gRPC (포트 50053) |

### JWT 토큰 구조

```json
{
  "sub": "username",
  "userId": "사용자 UUID",
  "tenantId": "테넌트 ID",
  "username": "사용자명",
  "email": "이메일",
  "roles": "ROLE_ADMIN,ROLE_USER",
  "authorities": ["MENU_VIEW", "USER_EDIT", "REPORT_EXPORT"],
  "iat": 1234567890,
  "exp": 1234568790
}
```

- **Access Token 유효기간**: 15분 (900초)
- **Refresh Token 유효기간**: 7일 (604800초)

---

## 인증 흐름

### 1. 로그인 및 토큰 발급

```
┌─────────┐      ┌─────────────┐      ┌─────────────┐
│ Client  │      │ Auth Service│      │   Redis     │
└────┬────┘      └──────┬──────┘      └──────┬──────┘
     │                  │                    │
     │ POST /auth/login │                    │
     │─────────────────>│                    │
     │                  │                    │
     │  Access Token +  │                    │
     │  Refresh Token   │                    │
     │<─────────────────│                    │
     │                  │                    │
```

### 2. API 요청 (다른 서비스)

```
┌─────────┐      ┌─────────────┐      ┌─────────────┐
│ Client  │      │ Your Service│      │   Redis     │
└────┬────┘      └──────┬──────┘      └──────┬──────┘
     │                  │                    │
     │ GET /api/xxx     │                    │
     │ Authorization:   │                    │
     │ Bearer {token}   │                    │
     │─────────────────>│                    │
     │                  │                    │
     │                  │ 블랙리스트 확인     │
     │                  │───────────────────>│
     │                  │<───────────────────│
     │                  │                    │
     │                  │ JWT 서명 검증       │
     │                  │ (로컬 처리)         │
     │                  │                    │
     │   Response       │                    │
     │<─────────────────│                    │
     │                  │                    │
```

### 3. 토큰 갱신

```
┌─────────┐      ┌─────────────┐
│ Client  │      │ Auth Service│
└────┬────┘      └──────┬──────┘
     │                  │
     │ POST /auth/refresh
     │ Refresh Token    │
     │─────────────────>│
     │                  │
     │ New Access Token │
     │<─────────────────│
     │                  │
```

---

## 의존성 추가

### build.gradle.kts

```kotlin
dependencies {
    // JWT 인증 (필수)
    implementation("lotecs:lotecs-auth-spring-boot-starter")

    // gRPC 클라이언트 SDK (Auth API 호출 시)
    implementation("lotecs.auth:lotecs-auth-grpc-sdk:1.0.0-SNAPSHOT")

    // 멀티테넌시 (필요 시)
    implementation("lotecs:lotecs-tenant-spring-boot-starter")
}
```

### build.gradle (Groovy)

```groovy
dependencies {
    // JWT 인증 (필수)
    implementation 'lotecs:lotecs-auth-spring-boot-starter'

    // gRPC 클라이언트 SDK (Auth API 호출 시)
    implementation 'lotecs.auth:lotecs-auth-grpc-sdk:1.0.0-SNAPSHOT'

    // 멀티테넌시 (필요 시)
    implementation 'lotecs:lotecs-tenant-spring-boot-starter'
}
```

### 포함되는 모듈

`lotecs-auth-spring-boot-starter`는 다음 모듈을 포함한다:

| 모듈 | 기능 |
|------|------|
| lotecs-jwt-core | JWT 토큰 생성/검증 |
| lotecs-jwt-web | HTTP 요청 JWT 필터 |
| lotecs-jwt-redis | 토큰 블랙리스트 (Redis) |
| lotecs-security-web | 보안 필터 |

---

## 설정

### application.yml

```yaml
# JWT 설정
lotecs:
  jwt:
    enabled: true
    secret: ${LOTECS_JWT_SECRET}  # Auth 서비스와 동일한 키 사용 (필수)
    issuer: "lotecs-platform"
    audience: "lotecs-services"
    clock-skew-seconds: 30

    # 블랙리스트 (로그아웃 토큰 차단)
    blacklist:
      enabled: true
      storage: redis
      redis:
        key-prefix: "lotecs:jwt:blacklist:"

    # 웹 필터 설정
    web:
      enabled: true
      filter:
        exclude-paths:  # JWT 검증 제외 경로
          - /api/public/**
          - /actuator/**
          - /health
        token-expired-header:
          enabled: true
          header-name: X-Token-Expired

      # JWT에서 권한 추출
      authority-claim:
        enabled: true
        claim-key: "authorities"
        merge-with-roles: true

# gRPC 클라이언트 설정 (Auth API 호출 시)
grpc:
  client:
    auth-service:
      address: static://${AUTH_SERVICE_HOST:localhost}:${AUTH_SERVICE_GRPC_PORT:50053}
      negotiationType: ${GRPC_NEGOTIATION_TYPE:plaintext}

# Redis 설정 (블랙리스트용)
spring:
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}

# 멀티테넌시 설정 (필요 시)
lotecs:
  tenant:
    enabled: true
    default-tenant-id: SYSTEM
    web:
      enabled: true
      filter:
        order: 1
      resolver:
        header:
          enabled: true
          header-name: X-Tenant-Id
```

### 환경변수

| 변수 | 설명 | 필수 |
|------|------|------|
| LOTECS_JWT_SECRET | JWT 서명 키 (Auth 서비스와 동일) | O |
| REDIS_HOST | Redis 호스트 | O |
| REDIS_PORT | Redis 포트 | - |
| AUTH_SERVICE_HOST | Auth gRPC 서버 호스트 | gRPC 사용 시 |
| AUTH_SERVICE_GRPC_PORT | Auth gRPC 서버 포트 (기본: 50053) | - |
