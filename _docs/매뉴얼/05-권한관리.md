# 권한 관리

JWT 토큰의 권한 정보를 활용한 접근 제어 방법을 설명한다.

## 어노테이션 기반 (권장)

JWT의 `authorities` 클레임에 포함된 권한으로 접근 제어:

```java
@RestController
@RequestMapping("/api/users")
public class UserController {

    // 특정 권한 필요
    @PreAuthorize("hasAuthority('USER_VIEW')")
    @GetMapping
    public List<UserDto> getUsers() {
        // ...
    }

    // 여러 권한 중 하나
    @PreAuthorize("hasAnyAuthority('USER_EDIT', 'USER_ADMIN')")
    @PutMapping("/{id}")
    public UserDto updateUser(@PathVariable String id, @RequestBody UserDto dto) {
        // ...
    }

    // 역할 기반
    @PreAuthorize("hasRole('ADMIN')")
    @DeleteMapping("/{id}")
    public void deleteUser(@PathVariable String id) {
        // ...
    }

    // 복합 조건
    @PreAuthorize("hasRole('ADMIN') or hasAuthority('USER_DELETE')")
    @DeleteMapping("/batch")
    public void deleteUsers(@RequestBody List<String> ids) {
        // ...
    }

    // 사용자 본인 확인
    @PreAuthorize("#userId == authentication.principal.userId or hasRole('ADMIN')")
    @GetMapping("/{userId}/profile")
    public UserProfileDto getProfile(@PathVariable String userId) {
        // ...
    }
}
```

---

## 프로그래밍 방식

```java
@Service
@RequiredArgsConstructor
public class ReportService {

    private final AuthServiceClient authServiceClient;

    public ReportDto generateReport(String reportType) {
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        JwtAuthenticationToken token = (JwtAuthenticationToken) auth;

        // 1. 로컬 권한 체크 (JWT 클레임 기반)
        boolean hasLocalAuthority = auth.getAuthorities().stream()
            .anyMatch(a -> a.getAuthority().equals("REPORT_GENERATE"));

        // 2. gRPC를 통한 실시간 권한 체크 (최신 권한 확인 필요 시)
        boolean hasRemotePermission = authServiceClient.checkPermission(
            token.getUserId(),
            token.getTenantId(),
            "REPORT_GENERATE"
        );

        if (!hasLocalAuthority && !hasRemotePermission) {
            throw new AccessDeniedException("권한이 없습니다.");
        }

        // 보고서 생성 로직
        return generateReportInternal(reportType);
    }
}
```

---

## 권한 체크 방식 비교

| 방식 | 장점 | 단점 | 사용 시점 |
|------|------|------|-----------|
| JWT 클레임 (@PreAuthorize) | 빠름 (네트워크 호출 없음) | 토큰 발급 후 권한 변경 미반영 | 일반적인 경우 |
| gRPC 실시간 조회 | 항상 최신 권한 | 네트워크 지연 | 중요한 작업, 권한 변경 즉시 반영 필요 시 |

---

## SecurityConfig 설정

권한 기반 접근 제어를 사용하려면 `@EnableMethodSecurity`를 활성화해야 한다:

```java
@Configuration
@EnableWebSecurity
@EnableMethodSecurity(prePostEnabled = true)
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .csrf(csrf -> csrf.disable())
            .sessionManagement(session ->
                session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/api/public/**").permitAll()
                .requestMatchers("/actuator/**").permitAll()
                .requestMatchers("/api/admin/**").hasRole("ADMIN")
                .anyRequest().authenticated()
            );

        return http.build();
    }
}
```
