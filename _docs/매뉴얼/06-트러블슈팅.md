# 트러블슈팅

LOTECS Auth 연동 시 발생할 수 있는 문제와 해결 방법을 설명한다.

## 1. JWT 검증 실패

**증상**: 401 Unauthorized 응답

**원인 및 해결**:

| 원인 | 해결 |
|------|------|
| JWT Secret 불일치 | `LOTECS_JWT_SECRET` 환경변수가 Auth 서비스와 동일한지 확인 |
| 토큰 만료 | Access Token 갱신 (POST /auth/refresh) |
| 토큰 블랙리스트 등록 | 재로그인 필요 |
| Redis 연결 실패 | Redis 연결 상태 확인 |

**디버깅**:
```yaml
logging:
  level:
    lotecs.security: DEBUG
    lotecs.jwt: DEBUG
```

---

## 2. 권한 없음 (403 Forbidden)

**증상**: 인증은 성공했으나 403 응답

**확인 사항**:
1. JWT에 필요한 권한이 포함되어 있는지 확인
2. `@PreAuthorize` 표현식 확인
3. 역할과 권한 구분 (`hasRole` vs `hasAuthority`)

**JWT 클레임 확인**:
```java
// JWT 디코딩하여 authorities 확인
// https://jwt.io 에서 토큰 디코딩
```

---

## 3. gRPC 연결 실패

**증상**: UNAVAILABLE 에러

**확인 사항**:
```bash
# Auth 서비스 gRPC 포트 확인
nc -zv {AUTH_SERVICE_HOST} 50053

# 설정 확인
grpc.client.auth-service.address=static://host:50053
```

---

## 4. 테넌트 불일치

**증상**: 403 Forbidden (Tenant mismatch)

**원인**: JWT의 tenantId와 X-Tenant-Id 헤더 불일치

**해결**: 요청 헤더의 테넌트 ID가 로그인한 사용자의 테넌트와 일치하는지 확인

---

## 5. 토큰 만료 감지

응답 헤더에 `X-Token-Expired: true`가 포함되면 토큰이 곧 만료됨을 의미한다. 클라이언트는 이 헤더를 감지하여 토큰을 미리 갱신할 수 있다.

```javascript
// 클라이언트 예시
axios.interceptors.response.use(response => {
    if (response.headers['x-token-expired'] === 'true') {
        // 토큰 갱신 로직
        refreshToken();
    }
    return response;
});
```

---

## 6. SSO 연결 실패

**증상**: SSO 인증 시 타임아웃 또는 연결 오류

**확인 사항**:
1. SSO 서버 URL이 올바른지 확인
2. 네트워크 연결 상태 확인
3. 타임아웃 설정 확인 (`readTimeoutMs`)
4. Fallback 설정 활성화 여부 확인

**Fallback 활성화**:
```java
TenantSsoConfig.builder()
    .fallbackEnabled(true)
    .fallbackPasswordRequired(true)
    .build();
```

---

## 참고

- [LOTECS Auth README](../../README.md)
- [gRPC Proto 정의](../../lotecs-auth-grpc-api/src/main/proto/auth_service.proto)
