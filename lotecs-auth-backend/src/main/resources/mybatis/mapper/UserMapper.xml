<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="lotecs.auth.infrastructure.persistence.user.mapper.UserMapper">

    <!-- User ResultMap -->
    <resultMap id="userResultMap" type="lotecs.auth.domain.user.model.User">
        <id property="userId" column="USER_ID"/>
        <result property="tenantId" column="TENANT_ID"/>
        <result property="username" column="USERNAME"/>
        <result property="password" column="PASSWORD"/>
        <result property="email" column="EMAIL"/>
        <result property="phoneNumber" column="PHONE_NUMBER"/>
        <result property="fullName" column="FULL_NAME"/>
        <result property="status" column="STATUS"/>
        <result property="accountNonLocked" column="ACCOUNT_NON_LOCKED"/>
        <result property="credentialsNonExpired" column="CREDENTIALS_NON_EXPIRED"/>
        <result property="enabled" column="ENABLED"/>
        <result property="lastLoginAt" column="LAST_LOGIN_AT"/>
        <result property="lastLoginIp" column="LAST_LOGIN_IP"/>
        <result property="failedLoginAttempts" column="FAILED_LOGIN_ATTEMPTS"/>
        <result property="lockedAt" column="LOCKED_AT"/>
        <result property="passwordChangedAt" column="PASSWORD_CHANGED_AT"/>
        <result property="createdBy" column="CREATED_BY"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="updatedBy" column="UPDATED_BY"/>
        <result property="updatedAt" column="UPDATED_AT"/>
    </resultMap>

    <!-- ID로 사용자 조회 -->
    <select id="findById" resultMap="userResultMap">
        SELECT
            USER_ID,
            TENANT_ID,
            USERNAME,
            PASSWORD,
            EMAIL,
            PHONE_NUMBER,
            FULL_NAME,
            STATUS,
            ACCOUNT_NON_LOCKED,
            CREDENTIALS_NON_EXPIRED,
            ENABLED,
            LAST_LOGIN_AT,
            LAST_LOGIN_IP,
            FAILED_LOGIN_ATTEMPTS,
            LOCKED_AT,
            PASSWORD_CHANGED_AT,
            CREATED_BY,
            CREATED_AT,
            UPDATED_BY,
            UPDATED_AT
        FROM AUTH_USERS
        WHERE USER_ID = #{userId}
    </select>

    <!-- 사용자명과 테넌트 ID로 사용자 조회 -->
    <select id="findByUsernameAndTenantId" resultMap="userResultMap">
        SELECT
            USER_ID,
            TENANT_ID,
            USERNAME,
            PASSWORD,
            EMAIL,
            PHONE_NUMBER,
            FULL_NAME,
            STATUS,
            ACCOUNT_NON_LOCKED,
            CREDENTIALS_NON_EXPIRED,
            ENABLED,
            LAST_LOGIN_AT,
            LAST_LOGIN_IP,
            FAILED_LOGIN_ATTEMPTS,
            LOCKED_AT,
            PASSWORD_CHANGED_AT,
            CREATED_BY,
            CREATED_AT,
            UPDATED_BY,
            UPDATED_AT
        FROM AUTH_USERS
        WHERE USERNAME = #{username}
          AND TENANT_ID = #{tenantId}
    </select>

    <!-- 테넌트 ID로 사용자 목록 조회 (페이징) -->
    <select id="findByTenantId" resultMap="userResultMap">
        SELECT * FROM (
            SELECT
                A.*,
                ROWNUM RNUM
            FROM (
                SELECT
                    USER_ID,
                    TENANT_ID,
                    USERNAME,
                    PASSWORD,
                    EMAIL,
                    PHONE_NUMBER,
                    FULL_NAME,
                    STATUS,
                    ACCOUNT_NON_LOCKED,
                    CREDENTIALS_NON_EXPIRED,
                    ENABLED,
                    LAST_LOGIN_AT,
                    LAST_LOGIN_IP,
                    FAILED_LOGIN_ATTEMPTS,
                    LOCKED_AT,
                    PASSWORD_CHANGED_AT,
                    CREATED_BY,
                    CREATED_AT,
                    UPDATED_BY,
                    UPDATED_AT
                FROM AUTH_USERS
                WHERE TENANT_ID = #{tenantId}
                ORDER BY CREATED_AT DESC
            ) A
            WHERE ROWNUM &lt;= #{offset} + #{limit}
        )
        WHERE RNUM > #{offset}
    </select>

    <!-- 테넌트 ID로 사용자 수 조회 -->
    <select id="countByTenantId" resultType="int">
        SELECT COUNT(*)
        FROM AUTH_USERS
        WHERE TENANT_ID = #{tenantId}
    </select>

    <!-- 사용자 등록 -->
    <insert id="insert" parameterType="lotecs.auth.domain.user.model.User">
        <selectKey keyProperty="userId" resultType="long" order="BEFORE">
            SELECT AUTH_USERS_SEQ.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO AUTH_USERS (
            USER_ID,
            TENANT_ID,
            USERNAME,
            PASSWORD,
            EMAIL,
            PHONE_NUMBER,
            FULL_NAME,
            STATUS,
            ACCOUNT_NON_LOCKED,
            CREDENTIALS_NON_EXPIRED,
            ENABLED,
            LAST_LOGIN_AT,
            LAST_LOGIN_IP,
            FAILED_LOGIN_ATTEMPTS,
            LOCKED_AT,
            PASSWORD_CHANGED_AT,
            CREATED_BY,
            CREATED_AT,
            UPDATED_BY,
            UPDATED_AT
        ) VALUES (
            #{userId},
            #{tenantId},
            #{username},
            #{password},
            #{email},
            #{phoneNumber},
            #{fullName},
            #{status},
            #{accountNonLocked},
            #{credentialsNonExpired},
            #{enabled},
            #{lastLoginAt},
            #{lastLoginIp},
            #{failedLoginAttempts},
            #{lockedAt},
            #{passwordChangedAt},
            #{createdBy},
            #{createdAt},
            #{updatedBy},
            #{updatedAt}
        )
    </insert>

    <!-- 사용자 정보 수정 -->
    <update id="update" parameterType="lotecs.auth.domain.user.model.User">
        UPDATE AUTH_USERS
        SET
            PASSWORD = #{password},
            EMAIL = #{email},
            PHONE_NUMBER = #{phoneNumber},
            FULL_NAME = #{fullName},
            STATUS = #{status},
            ACCOUNT_NON_LOCKED = #{accountNonLocked},
            CREDENTIALS_NON_EXPIRED = #{credentialsNonExpired},
            ENABLED = #{enabled},
            LAST_LOGIN_AT = #{lastLoginAt},
            LAST_LOGIN_IP = #{lastLoginIp},
            FAILED_LOGIN_ATTEMPTS = #{failedLoginAttempts},
            LOCKED_AT = #{lockedAt},
            PASSWORD_CHANGED_AT = #{passwordChangedAt},
            UPDATED_BY = #{updatedBy},
            UPDATED_AT = #{updatedAt}
        WHERE USER_ID = #{userId}
    </update>

    <!-- 사용자 삭제 -->
    <delete id="delete">
        DELETE FROM AUTH_USERS
        WHERE USER_ID = #{userId}
    </delete>

</mapper>
