<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="lotecs.auth.infrastructure.persistence.user.mapper.UserMapper">

    <!-- User ResultMap -->
    <resultMap id="userResultMap" type="lotecs.auth.domain.user.model.User">
        <id property="userId" column="USER_ID"/>
        <result property="tenantId" column="TENANT_ID"/>
        <result property="username" column="USERNAME"/>
        <result property="password" column="PASSWORD"/>
        <result property="email" column="EMAIL"/>
        <result property="phoneNumber" column="PHONE_NUMBER"/>
        <result property="fullName" column="FULL_NAME"/>
        <result property="status" column="STATUS"/>
        <result property="accountNonLocked" column="ACCOUNT_NON_LOCKED"/>
        <result property="credentialsNonExpired" column="CREDENTIALS_NON_EXPIRED"/>
        <result property="enabled" column="ENABLED"/>
        <result property="lastLoginAt" column="LAST_LOGIN_AT"/>
        <result property="lastLoginIp" column="LAST_LOGIN_IP"/>
        <result property="failedLoginAttempts" column="FAILED_LOGIN_ATTEMPTS"/>
        <result property="lockedAt" column="LOCKED_AT"/>
        <result property="passwordChangedAt" column="PASSWORD_CHANGED_AT"/>
        <result property="createdBy" column="CREATED_BY"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="updatedBy" column="UPDATED_BY"/>
        <result property="updatedAt" column="UPDATED_AT"/>
        <result property="deletedAt" column="DELETED_AT"/>
    </resultMap>

    <!-- 공통 컬럼 -->
    <sql id="userColumns">
        USER_ID,
        TENANT_ID,
        USERNAME,
        PASSWORD,
        EMAIL,
        PHONE_NUMBER,
        FULL_NAME,
        STATUS,
        ACCOUNT_NON_LOCKED,
        CREDENTIALS_NON_EXPIRED,
        ENABLED,
        LAST_LOGIN_AT,
        LAST_LOGIN_IP,
        FAILED_LOGIN_ATTEMPTS,
        LOCKED_AT,
        PASSWORD_CHANGED_AT,
        CREATED_BY,
        CREATED_AT,
        UPDATED_BY,
        UPDATED_AT,
        DELETED_AT
    </sql>

    <!-- ID로 사용자 조회 -->
    <select id="findById" resultMap="userResultMap">
        SELECT
            <include refid="userColumns"/>
        FROM ATH_USERS
        WHERE USER_ID = #{userId}
          AND DELETED_AT IS NULL
    </select>

    <!-- 사용자명과 테넌트 ID로 사용자 조회 -->
    <select id="findByUsernameAndTenantId" resultMap="userResultMap">
        SELECT
            <include refid="userColumns"/>
        FROM ATH_USERS
        WHERE USERNAME = #{username}
          AND TENANT_ID = #{tenantId}
          AND DELETED_AT IS NULL
    </select>

    <!-- 이메일과 테넌트 ID로 사용자 조회 -->
    <select id="findByEmailAndTenantId" resultMap="userResultMap">
        SELECT
            <include refid="userColumns"/>
        FROM ATH_USERS
        WHERE EMAIL = #{email}
          AND TENANT_ID = #{tenantId}
          AND DELETED_AT IS NULL
    </select>

    <!-- 테넌트 ID로 사용자 목록 조회 (페이징) -->
    <select id="findByTenantId" resultMap="userResultMap">
        SELECT * FROM (
            SELECT
                A.*,
                ROWNUM RNUM
            FROM (
                SELECT
                    <include refid="userColumns"/>
                FROM ATH_USERS
                WHERE TENANT_ID = #{tenantId}
                  AND DELETED_AT IS NULL
                ORDER BY CREATED_AT DESC
            ) A
            WHERE ROWNUM &lt;= #{offset} + #{limit}
        )
        WHERE RNUM > #{offset}
    </select>

    <!-- 테넌트 ID로 사용자 수 조회 -->
    <select id="countByTenantId" resultType="int">
        SELECT COUNT(*)
        FROM ATH_USERS
        WHERE TENANT_ID = #{tenantId}
          AND DELETED_AT IS NULL
    </select>

    <!-- 사용자 등록 -->
    <insert id="insert" parameterType="lotecs.auth.domain.user.model.User">
        INSERT INTO ATH_USERS (
            USER_ID,
            TENANT_ID,
            USERNAME,
            PASSWORD,
            EMAIL,
            PHONE_NUMBER,
            FULL_NAME,
            STATUS,
            ACCOUNT_NON_LOCKED,
            CREDENTIALS_NON_EXPIRED,
            ENABLED,
            LAST_LOGIN_AT,
            LAST_LOGIN_IP,
            FAILED_LOGIN_ATTEMPTS,
            LOCKED_AT,
            PASSWORD_CHANGED_AT,
            CREATED_BY,
            CREATED_AT,
            UPDATED_BY,
            UPDATED_AT
        ) VALUES (
            #{userId},
            #{tenantId},
            #{username},
            #{password},
            #{email},
            #{phoneNumber},
            #{fullName},
            #{status},
            #{accountNonLocked},
            #{credentialsNonExpired},
            #{enabled},
            #{lastLoginAt},
            #{lastLoginIp},
            #{failedLoginAttempts},
            #{lockedAt},
            #{passwordChangedAt},
            #{createdBy},
            #{createdAt},
            #{updatedBy},
            #{updatedAt}
        )
    </insert>

    <!-- 사용자 정보 수정 -->
    <update id="update" parameterType="lotecs.auth.domain.user.model.User">
        UPDATE ATH_USERS
        SET
            PASSWORD = #{password},
            EMAIL = #{email},
            PHONE_NUMBER = #{phoneNumber},
            FULL_NAME = #{fullName},
            STATUS = #{status},
            ACCOUNT_NON_LOCKED = #{accountNonLocked},
            CREDENTIALS_NON_EXPIRED = #{credentialsNonExpired},
            ENABLED = #{enabled},
            LAST_LOGIN_AT = #{lastLoginAt},
            LAST_LOGIN_IP = #{lastLoginIp},
            FAILED_LOGIN_ATTEMPTS = #{failedLoginAttempts},
            LOCKED_AT = #{lockedAt},
            PASSWORD_CHANGED_AT = #{passwordChangedAt},
            UPDATED_BY = #{updatedBy},
            UPDATED_AT = #{updatedAt}
        WHERE USER_ID = #{userId}
          AND DELETED_AT IS NULL
    </update>

    <!-- 사용자 삭제 (Soft Delete) -->
    <update id="delete">
        UPDATE ATH_USERS
        SET DELETED_AT = CURRENT_TIMESTAMP,
            UPDATED_AT = CURRENT_TIMESTAMP
        WHERE USER_ID = #{userId}
          AND DELETED_AT IS NULL
    </update>

    <!-- 사용자 삭제 (Hard Delete) - 테스트/관리용 -->
    <delete id="hardDelete">
        DELETE FROM ATH_USERS
        WHERE USER_ID = #{userId}
    </delete>

</mapper>
