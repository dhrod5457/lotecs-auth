<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="lotecs.auth.infrastructure.persistence.user.mapper.PermissionMapper">

    <!-- Permission ResultMap -->
    <resultMap id="permissionResultMap" type="lotecs.auth.domain.user.model.Permission">
        <id property="permissionId" column="PERMISSION_ID"/>
        <result property="tenantId" column="TENANT_ID"/>
        <result property="permissionName" column="PERMISSION_NAME"/>
        <result property="resource" column="RESOURCE_NAME"/>
        <result property="action" column="ACTION"/>
        <result property="description" column="DESCRIPTION"/>
        <result property="createdBy" column="CREATED_BY"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="updatedBy" column="UPDATED_BY"/>
        <result property="updatedAt" column="UPDATED_AT"/>
        <result property="deletedAt" column="DELETED_AT"/>
    </resultMap>

    <!-- 공통 컬럼 -->
    <sql id="permissionColumns">
        PERMISSION_ID,
        TENANT_ID,
        PERMISSION_NAME,
        RESOURCE_NAME,
        ACTION,
        DESCRIPTION,
        CREATED_BY,
        CREATED_AT,
        UPDATED_BY,
        UPDATED_AT,
        DELETED_AT
    </sql>

    <!-- ID로 권한 조회 -->
    <select id="findById" resultMap="permissionResultMap">
        SELECT
            <include refid="permissionColumns"/>
        FROM ATH_PERMISSIONS
        WHERE PERMISSION_ID = #{permissionId}
          AND DELETED_AT IS NULL
    </select>

    <!-- 권한명으로 권한 조회 -->
    <select id="findByPermissionName" resultMap="permissionResultMap">
        SELECT
            <include refid="permissionColumns"/>
        FROM ATH_PERMISSIONS
        WHERE PERMISSION_NAME = #{permissionName}
          AND TENANT_ID = #{tenantId}
          AND DELETED_AT IS NULL
    </select>

    <!-- 리소스와 액션으로 권한 조회 -->
    <select id="findByResourceAndAction" resultMap="permissionResultMap">
        SELECT
            <include refid="permissionColumns"/>
        FROM ATH_PERMISSIONS
        WHERE RESOURCE_NAME = #{resource}
          AND ACTION = #{action}
          AND TENANT_ID = #{tenantId}
          AND DELETED_AT IS NULL
    </select>

    <!-- 테넌트 ID로 모든 권한 조회 -->
    <select id="findByTenantId" resultMap="permissionResultMap">
        SELECT
            <include refid="permissionColumns"/>
        FROM ATH_PERMISSIONS
        WHERE TENANT_ID = #{tenantId}
          AND DELETED_AT IS NULL
        ORDER BY RESOURCE_NAME ASC, ACTION ASC
    </select>

    <!-- 역할 ID로 권한 목록 조회 -->
    <select id="findByRoleId" resultMap="permissionResultMap">
        SELECT
            P.PERMISSION_ID,
            P.TENANT_ID,
            P.PERMISSION_NAME,
            P.RESOURCE_NAME,
            P.ACTION,
            P.DESCRIPTION,
            P.CREATED_BY,
            P.CREATED_AT,
            P.UPDATED_BY,
            P.UPDATED_AT,
            P.DELETED_AT
        FROM ATH_PERMISSIONS P
        INNER JOIN ATH_ROLE_PERMISSIONS RP ON P.PERMISSION_ID = RP.PERMISSION_ID
        WHERE RP.ROLE_ID = #{roleId}
          AND P.DELETED_AT IS NULL
        ORDER BY P.RESOURCE_NAME ASC, P.ACTION ASC
    </select>

    <!-- 권한 등록 -->
    <insert id="insert" parameterType="lotecs.auth.domain.user.model.Permission">
        INSERT INTO ATH_PERMISSIONS (
            PERMISSION_ID,
            TENANT_ID,
            PERMISSION_NAME,
            RESOURCE_NAME,
            ACTION,
            DESCRIPTION,
            CREATED_BY,
            CREATED_AT,
            UPDATED_BY,
            UPDATED_AT
        ) VALUES (
            #{permissionId},
            #{tenantId},
            #{permissionName},
            #{resource},
            #{action},
            #{description},
            #{createdBy},
            #{createdAt},
            #{updatedBy},
            #{updatedAt}
        )
    </insert>

    <!-- 권한 정보 수정 -->
    <update id="update" parameterType="lotecs.auth.domain.user.model.Permission">
        UPDATE ATH_PERMISSIONS
        SET
            DESCRIPTION = #{description},
            UPDATED_BY = #{updatedBy},
            UPDATED_AT = #{updatedAt}
        WHERE PERMISSION_ID = #{permissionId}
          AND DELETED_AT IS NULL
    </update>

    <!-- 권한 삭제 (Soft Delete) -->
    <update id="delete">
        UPDATE ATH_PERMISSIONS
        SET DELETED_AT = CURRENT_TIMESTAMP,
            UPDATED_AT = CURRENT_TIMESTAMP
        WHERE PERMISSION_ID = #{permissionId}
          AND DELETED_AT IS NULL
    </update>

</mapper>
